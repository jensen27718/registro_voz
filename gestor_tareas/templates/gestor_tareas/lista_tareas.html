{% extends 'base.html' %}

{% block title %}Lista de Tareas{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <form id="filtersForm" method="get" class="w-full">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
            <div class="flex flex-col gap-1 w-full sm:w-auto">
                <nav class="text-sm text-gray-500">Dashboard / <span class="text-gray-700">Tareas</span></nav>
                <h1 class="text-2xl font-bold text-[#0F172A]">Gestor de <span class="text-teal-600">Tareas</span></h1>
            </div>
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <input name="q" id="searchInput" type="search" placeholder="Buscar..." value="{{ filtros.q }}" class="flex-grow sm:flex-none border border-[#E5E7EB] rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500" />
                <button type="button" id="notesToggle" class="bg-gray-200 text-[#0F172A] px-4 py-2 rounded-md">Notas</button>
                <a href="{% url 'gestor_tareas:agregar_tarea_voz' %}" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md">+ Nueva tarea</a>
            </div>
        </header>

        <div class="flex flex-wrap gap-2 mb-4">
            <select name="estado" onchange="this.form.submit()" class="px-3 py-1 rounded-full bg-gray-200 text-sm">
                <option value="">Estado</option>
                {% for value, label in estados_posibles %}
                <option value="{{ value }}" {% if filtros.estado == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <select name="prioridad" onchange="this.form.submit()" class="px-3 py-1 rounded-full bg-gray-200 text-sm">
                <option value="">Prioridad</option>
                {% for p in prioridades_posibles %}
                <option value="{{ p }}" {% if filtros.prioridad == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
            <select name="tipo" onchange="this.form.submit()" class="px-3 py-1 rounded-full bg-gray-200 text-sm">
                <option value="">Tipo</option>
                {% for t in tipos_posibles %}
                <option value="{{ t }}" {% if filtros.tipo == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
        </div>
    </form>


    <div id="status-message" class="mb-4 text-center font-medium h-6 transition-opacity duration-300"></div>


    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left table-auto">
                <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                <tr>
                    <th class="px-4 py-3">Orden</th>
                    <th class="px-4 py-3">Recibido</th>
                    <th class="px-4 py-3">Cliente</th>
                    <th class="px-4 py-3">Tipo</th>
                    <th class="px-4 py-3">Tarea</th>
                    <th class="px-4 py-3">Estado</th>
                    <th class="px-4 py-3">Prioridad</th>
                    <th class="px-4 py-3 text-right">Acciones</th>
                    <th class="px-4 py-3">Mover</th>
                </tr>
                </thead>
                <tbody id="tareas-body" class="divide-y divide-[#E5E7EB]">
                    {% for tarea in tareas %}
                    <tr id="tarea-row-{{ tarea.id }}" class="hover:bg-gray-50 transition-colors" draggable="true" data-id="{{ tarea.id }}">
                        <td class="px-4 py-3 text-lg font-semibold orden-cell">{{ tarea.orden|default:0 }}</td>
                        <td class="px-4 py-3">{{ tarea.dias_desde_recibido }}</td>
                        <td class="px-4 py-3">
                            {{ tarea.cliente }}{% if tarea.telefono %} · <a href="https://wa.me/{{ tarea.telefono|cut:' '|cut:'-' }}" target="_blank" class="text-teal-600 hover:underline">{{ tarea.telefono }}</a>{% endif %}
                        </td>
                        <td class="px-4 py-3">{{ tarea.tipo.nombre|default:"--" }}</td>
                        <td class="px-4 py-3 text-gray-600">
                            {% with tarea.descripcion|wordcount as cant_palabras %}
                                <span id="desc-short-{{ tarea.id }}">
                                    {{ tarea.descripcion|truncatewords:8|default:"--" }}
                                    {% if cant_palabras > 8 %}
                                        <a href="#" class="text-teal-600 ml-1" onclick="toggleDescripcion({{ tarea.id }}); return false;">▾</a>
                                    {% endif %}
                                </span>
                                {% if cant_palabras > 8 %}
                                <span id="desc-full-{{ tarea.id }}" class="hidden">
                                    {{ tarea.descripcion }}
                                    <a href="#" class="text-teal-600 ml-1" onclick="toggleDescripcion({{ tarea.id }}); return false;">▴</a>
                                </span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td class="px-4 py-3">
                            <select onchange="actualizarEstado(this)" data-task-id="{{ tarea.id }}" class="estado-select text-xs font-medium rounded-full px-2 py-1 focus:outline-none">
                                {% for value, label in estados_posibles %}
                                <option value="{{ value }}" {% if tarea.estado == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="px-4 py-3">
                          <span class="px-2 py-1 rounded-full text-xs font-medium text-white
                            {% if tarea.prioridad == 'Urgente' %} bg-red-500
                            {% elif tarea.prioridad == 'Alta' %} bg-orange-400
                            {% elif tarea.prioridad == 'Baja' %} bg-gray-400
                            {% else %} bg-blue-500 {% endif %}">
                            {{ tarea.prioridad }}
                          </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right">
                            <a href="{% url 'gestor_tareas:editar_tarea' tarea.id %}" class="text-teal-600 hover:underline mr-3">Editar</a>
                            <button onclick="ocultarTarea({{ tarea.id }})" class="text-red-600 hover:underline">Archivar</button>
                        </td>

                        <td class="px-4 py-3 text-gray-400 cursor-move text-center">☰</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center py-10 text-gray-500">No hay tareas visibles. ¡Agrega la primera!</td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const searchInput = document.getElementById('searchInput');
    document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement !== searchInput) {
            e.preventDefault();
            searchInput.focus();
        }
        if (e.key === 'n' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            window.location.href = "{% url 'gestor_tareas:agregar_tarea_voz' %}";
        }
    });

    const stateColors = {
        'Recibido': 'bg-blue-500 text-white',
        'En Proceso': 'bg-amber-500 text-white',
        'Completado': 'bg-green-500 text-white',
        'Bloqueado': 'bg-red-500 text-white',
        'En espera': 'bg-gray-500 text-white'
    };
    function styleEstado(select){
        const base = 'estado-select text-xs font-medium rounded-full px-2 py-1 focus:outline-none';
        select.className = base + ' ' + (stateColors[select.value] || 'bg-gray-200 text-gray-800');
    }
    document.querySelectorAll('.estado-select').forEach(styleEstado);

    async function actualizarEstado(selectElement) {
        const tareaId = selectElement.dataset.taskId;
        const nuevoEstado = selectElement.value;
        const statusBox = document.getElementById('status-message');

        statusBox.textContent = 'Actualizando...';
        statusBox.className = 'mb-4 text-center font-medium text-[#F59E0B]';

        try {
            const response = await fetch("{% url 'gestor_tareas:actualizar_estado' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ tarea_id: tareaId, nuevo_estado: nuevoEstado })
            });

            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);

            statusBox.textContent = `✅ ${result.message}`;
            statusBox.className = 'mb-4 text-center font-medium text-[#10B981]';
            styleEstado(selectElement);

            const row = document.getElementById(`tarea-row-${tareaId}`);
            if (nuevoEstado === 'Completado') {
                row.classList.add('completed-row');
            } else {
                row.classList.remove('completed-row');
            }

        } catch (error) {
            statusBox.textContent = `❌ Error: ${error.message}`;
            statusBox.className = 'mb-4 text-center font-medium text-[#EF4444]';
        } finally {
            setTimeout(() => { statusBox.textContent = ''; }, 3000);
        }
    }

    async function ocultarTarea(tareaId) {
        if (!confirm(`¿Archivar la tarea #${tareaId}?`)) { return; }

        const statusBox = document.getElementById('status-message');
        statusBox.textContent = 'Archivando...';
        statusBox.className = 'mb-4 text-center font-medium text-[#F59E0B]';

        try {
            const response = await fetch(`/tareas/ocultar/${tareaId}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            });

            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);

            statusBox.textContent = `✅ ${result.message}`;
            statusBox.className = 'mb-4 text-center font-medium text-[#10B981]';

            const row = document.getElementById(`tarea-row-${tareaId}`);
            if (row) {
                row.style.transition = 'opacity 0.5s ease-out';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 500);
            }

        } catch (error) {
            statusBox.textContent = `❌ Error: ${error.message}`;
            statusBox.className = 'mb-4 text-center font-medium text-[#EF4444]';
        } finally {
            setTimeout(() => { statusBox.textContent = ''; }, 3000);
        }
    }

    function toggleDescripcion(id) {
        const shortEl = document.getElementById(`desc-short-${id}`);
        const fullEl = document.getElementById(`desc-full-${id}`);
        if (shortEl && fullEl) {
            shortEl.classList.toggle('hidden');
            fullEl.classList.toggle('hidden');
        }
    }

    const notesDrawer = document.createElement('div');
    notesDrawer.id = 'notesDrawer';

    notesDrawer.className = 'fixed top-0 right-0 h-full w-full max-w-xs sm:w-80 bg-white shadow-lg transform translate-x-full transition-transform z-50';

    notesDrawer.innerHTML = `
        <div class="p-4 border-b border-[#E5E7EB] flex justify-between items-center">
            <h2 class="font-bold">Notas</h2>
            <button id="closeNotes" class="text-gray-500">✕</button>
        </div>

        <div class="p-4 text-sm overflow-y-auto h-full">

            <form id="noteForm" class="flex gap-2">
                <input id="noteInput" type="text" class="flex-grow border border-[#E5E7EB] p-2 rounded focus:outline-none" placeholder="Nueva nota...">
                <button type="submit" class="bg-teal-600 text-white px-2 rounded">+</button>
            </form>
            <ul id="notesList" class="mt-4 space-y-2"></ul>
        </div>`;
    document.body.appendChild(notesDrawer);

    document.body.classList.add('overflow-x-hidden');


    document.getElementById('notesToggle').addEventListener('click', () => {
        notesDrawer.classList.remove('translate-x-full');
    });
    document.body.addEventListener('click', (e) => {
        if (e.target.id === 'closeNotes') {
            notesDrawer.classList.add('translate-x-full');
        }
    });

    const notesList = document.getElementById('notesList');
    const noteForm = document.getElementById('noteForm');
    const noteInput = document.getElementById('noteInput');

    function loadNotes(){
        const notes = JSON.parse(localStorage.getItem('tareasNotas') || '[]');
        notesList.innerHTML = '';
        notes.forEach((note, idx) => {
            const li = document.createElement('li');
            li.className = 'relative bg-gray-100 p-2 rounded hover:bg-gray-200';
            const span = document.createElement('span');
            span.textContent = note;
            span.addEventListener('dblclick', () => {
                const nuevo = prompt('Editar nota', note);
                if(nuevo !== null){
                    notes[idx] = nuevo;
                    localStorage.setItem('tareasNotas', JSON.stringify(notes));
                    loadNotes();
                }
            });
            const btn = document.createElement('button');
            btn.textContent = 'x';
            btn.className = 'absolute top-1 right-1 text-red-500';
            btn.addEventListener('click', () => {
                notes.splice(idx,1);
                localStorage.setItem('tareasNotas', JSON.stringify(notes));
                loadNotes();
            });
            li.appendChild(span);
            li.appendChild(btn);
            notesList.appendChild(li);
        });
    }

    noteForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = noteInput.value.trim();
        if(!text) return;
        const notes = JSON.parse(localStorage.getItem('tareasNotas') || '[]');
        notes.push(text);
        localStorage.setItem('tareasNotas', JSON.stringify(notes));
        noteInput.value = '';
        loadNotes();
    });

    loadNotes();

    // --- Drag and drop para reordenar ---
    let dragged;
    document.querySelectorAll('#tareas-body tr').forEach(row => {
        row.addEventListener('dragstart', e => {
            dragged = row;
            e.dataTransfer.effectAllowed = 'move';

            row.classList.add('opacity-50');
        });
        row.addEventListener('dragend', () => {
            row.classList.remove('opacity-50');

        });
        row.addEventListener('dragover', e => {
            e.preventDefault();
            const target = e.currentTarget;
            if (dragged === target) return;
            const tbody = document.getElementById('tareas-body');
            const bounds = target.getBoundingClientRect();
            const offset = e.clientY - bounds.top;
            const midpoint = bounds.height / 2;
            if (offset > midpoint) {
                tbody.insertBefore(dragged, target.nextSibling);
            } else {
                tbody.insertBefore(dragged, target);
            }
        });

        row.addEventListener('dragenter', () => {
            if (row !== dragged) row.classList.add('bg-teal-50');
        });
        row.addEventListener('dragleave', () => {
            row.classList.remove('bg-teal-50');
        });
        row.addEventListener('drop', e => {
            e.preventDefault();
            row.classList.remove('bg-teal-50');

            actualizarOrdenServidor();
        });
    });

    function actualizarOrdenServidor(){
        const ordenes = [];
        document.querySelectorAll('#tareas-body tr').forEach((row, idx) => {
            ordenes.push({id: row.dataset.id, orden: idx + 1});
            const cell = row.querySelector('.orden-cell');
            if (cell) cell.textContent = idx + 1;
        });
        fetch("{% url 'gestor_tareas:reordenar_tareas' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ordenes})
        });
    }
</script>
{% endblock %}
