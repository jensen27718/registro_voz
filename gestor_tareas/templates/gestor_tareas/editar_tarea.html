{% extends 'base.html' %}

{% block title %}Editar Tarea #{{ tarea.id }}{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto px-4">
  <header class="mb-6">
    <h1 class="text-2xl font-bold text-[#0F172A]">Editar Tarea <span class="text-teal-600">#{{ tarea.id }}</span></h1>
    <a href="{% url 'gestor_tareas:lista_tareas' %}" class="text-teal-600 hover:underline">← Cancelar y volver a la lista</a>
  </header>
  <form method="POST" action="{% url 'gestor_tareas:editar_tarea' tarea.id %}" class="bg-white rounded-lg shadow p-6 space-y-4">
    {% csrf_token %}
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label for="cliente" class="block mb-1 text-sm font-medium text-gray-700">Cliente</label>
        <input type="text" name="cliente" id="cliente" value="{{ tarea.cliente }}" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-teal-500" required>
      </div>
      <div>
        <label for="telefono" class="block mb-1 text-sm font-medium text-gray-700">Teléfono (Opcional)</label>
        <input type="tel" name="telefono" id="telefono" value="{{ tarea.telefono|default_if_none:'' }}" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-teal-500">
      </div>
      <div>
        <label for="orden" class="block mb-1 text-sm font-medium text-gray-700">Orden</label>
        <input type="number" name="orden" id="orden" value="{{ tarea.orden|default_if_none:'' }}" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-teal-500">
      </div>
      <div class="sm:col-span-2">
        <label for="tipo" class="block mb-1 text-sm font-medium text-gray-700">Tipo de Trabajo</label>
        <select name="tipo" id="tipo" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-teal-500">
          {% for tipo in todos_los_tipos %}
          <option value="{{ tipo.nombre }}" {% if tarea.tipo and tarea.tipo.id == tipo.id %}selected{% endif %}>{{ tipo.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="prioridad" class="block mb-1 text-sm font-medium text-gray-700">Prioridad</label>
        <select name="prioridad" id="prioridad" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-teal-500">
          {% for value,label in todas_las_prioridades %}
          <option value="{{ value }}" {% if tarea.prioridad == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="estado" class="block mb-1 text-sm font-medium text-gray-700">Estado</label>
        <select name="estado" id="estado" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-teal-500">
          {% for value,label in todos_los_estados %}
          <option value="{{ value }}" {% if tarea.estado == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="sm:col-span-2">
        <label for="descripcion" class="block mb-1 text-sm font-medium text-gray-700">Descripción</label>
        <textarea name="descripcion" id="descripcion" rows="4" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-teal-500">{{ tarea.descripcion }}</textarea>
      </div>
    </div>
    {% if detalles %}
    <div class="mt-4">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Detalles</h2>
      <ul class="space-y-1">
        {% for det in detalles %}
        <li>
          <label class="inline-flex items-center">
            <input type="checkbox" name="detalle-{{ det.id }}-completado" {% if det.completado %}checked{% endif %} class="mr-2 rounded">
            {{ det.referencia|default:det.descripcion }} - {{ det.cantidad }} x {{ det.tamano }} {{ det.color }}{% if det.precio_unitario %} ({{ det.precio_unitario }} c/u){% endif %}
          </label>
        </li>
        {% endfor %}
      </ul>
      <p class="text-right font-semibold mt-2">Total: {{ tarea.costo_total }}</p>
    </div>
    {% endif %}
    <div class="flex justify-end gap-4 pt-4">
       <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-md">Guardar</button>
       <a href="{% url 'gestor_tareas:lista_tareas' %}" class="bg-gray-200 text-[#0F172A] py-2 px-4 rounded-md">Cancelar</a>
    </div>
  </form>

  <div class="mt-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-2">Agregar detalle manual</h2>
    <form method="POST" action="{% url 'gestor_tareas:agregar_detalle' tarea.id %}" enctype="multipart/form-data" class="space-y-2">
      {% csrf_token %}
      <div>
        <label class="block text-sm">Tipo de producto</label>
        <select name="tipo_producto" class="w-full border border-gray-300 rounded-md py-2 px-3">
          {% for tp in tipos_producto_catalogo %}
          <option value="{{ tp.id }}">{{ tp.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm">Variación (opcional)</label>
        <select name="variacion" class="w-full border border-gray-300 rounded-md py-2 px-3">
          <option value="">---------</option>
          {% for var in variaciones_catalogo %}
          <option value="{{ var.id }}">{{ var.producto.referencia }} - {{ var.producto.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="block text-sm">Tamaño</label>
          <select name="tamano" class="w-full border border-gray-300 rounded-md py-2 px-3">
            <option value="">---------</option>
            {% for v in tamanos %}
            <option value="{{ v.id }}">{{ v.display|default:v.valor }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm">Color</label>
          <select name="color" class="w-full border border-gray-300 rounded-md py-2 px-3">
            <option value="">---------</option>
            {% for v in colores %}
            <option value="{{ v.id }}">{{ v.display|default:v.valor }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm">Descripción</label>
        <input type="text" name="descripcion" class="w-full border border-gray-300 rounded-md py-2 px-3" />
      </div>
      <div>
        <label class="block text-sm">Datos adicionales</label>
        <input type="text" name="datos_adicionales" class="w-full border border-gray-300 rounded-md py-2 px-3" />
      </div>
      <div>
        <label class="block text-sm">Cantidad</label>
        <input type="number" name="cantidad" value="1" class="w-full border border-gray-300 rounded-md py-2 px-3" />
      </div>
      <div>
        <label class="block text-sm">Imagen (logos)</label>
        <input type="file" name="imagen" class="w-full border border-gray-300 rounded-md py-2 px-3" />
      </div>
      <div class="text-right">
        <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-md">Agregar</button>
      </div>
    </form>
  </div>

  <div class="mt-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-2">Agregar por OCR</h2>
    <form method="POST" action="{% url 'gestor_tareas:ocr_detalles' tarea.id %}" enctype="multipart/form-data" class="space-y-2">
      {% csrf_token %}
      <input type="file" name="imagen" class="w-full border border-gray-300 rounded-md py-2 px-3" required />
      <div class="text-right">
        <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-md">Procesar imagen</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
