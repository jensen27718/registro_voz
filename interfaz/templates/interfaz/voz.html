<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistente Contable</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tom‑Select -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <!-- Inter font -->
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    /* Mic pulse */
    .pulse {
      animation: pulse-animation 1.6s infinite;
    }
    @keyframes pulse-animation {
      0% {
        box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7);
      }
      100% {
        box-shadow: 0 0 0 25px rgba(14, 165, 233, 0);
      }
    }

    /* Dark‑mode tweaks for Tom‑Select */
    .ts-control {
      background-color: #334155 !important;
      border-color: #475569 !important;
      color: #fff !important;
    }
    .ts-dropdown {
      background-color: #334155 !important;
      border-color: #475569 !important;
    }
    .ts-dropdown .option,
    .ts-dropdown .create {
      color: #cbd5e1 !important;
    }
    .ts-dropdown .active {
      background-color: #0ea5e9 !important;
      color: #fff !important;
    }

    /* Remove number input spinners */
    input[type='number']::-webkit-outer-spin-button,
    input[type='number']::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type='number'] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-900 to-slate-800 text-white min-h-screen flex flex-col items-center justify-center px-4 py-6">
  <!-- Header -->
  <header class="w-full max-w-md text-center mb-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">
      Asistente&nbsp;<span class="text-cyan-400">Contable</span>
    </h1>
  </header>

  <!-- Interaction card -->
  <main class="w-full max-w-md space-y-6">
    <section id="interactionContainer" class="w-full bg-slate-800/60 backdrop-blur rounded-2xl shadow-2xl p-6">
      <!-- Instruction -->
      <p id="instructionText" class="text-center text-base sm:text-lg text-cyan-400 mb-6">
        Presiona el micrófono para hablar.
      </p>

      <!-- Mic button -->
      <button
        id="talkButton"
        class="mx-auto flex items-center justify-center w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-cyan-600 hover:bg-cyan-700 transition-all focus:outline-none focus:ring-4 focus:ring-cyan-500"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
          class="w-10 h-10"
        >
          <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" />
          <path
            fill-rule="evenodd"
            d="M5.5 8.5A.5.5 0 016 9v1a4 4 0 004 4h.01a4 4 0 004-4V9a.5.5 0 011 0v1a5 5 0 01-4.5 4.975V17h1.5a.5.5 0 010 1h-4a.5.5 0 010-1H10v-2.025A5 5 0 015.5 10V9a.5.5 0 01.5-.5z"
            clip-rule="evenodd"
          />
        </svg>
        <span class="sr-only">Iniciar dictado</span>
      </button>

      <!-- Dynamic form -->
      <form id="formContainer" class="hidden mt-8 space-y-4 text-sm">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Fecha -->
          <div>
            <label
              for="input-fecha"
              class="block mb-1 text-slate-400 font-medium"
              >Fecha</label
            >
            <input
              type="date"
              id="input-fecha"
              class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
            />
          </div>
          <!-- Descripción -->
          <div>
            <label
              for="input-descripcion"
              class="block mb-1 text-slate-400 font-medium"
              >Descripción</label
            >
            <input
              type="text"
              id="input-descripcion"
              class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
            />
          </div>

          <!-- Categoría -->
          <div class="sm:col-span-2">
            <label for="select-categoria" class="block mb-1 text-slate-400 font-medium"
              >Categoría</label
            >
            <div class="flex items-center gap-2">
              <select id="select-categoria" class="flex-grow" placeholder="Busca o selecciona..."></select>
              <button
                type="button"
                onclick="crearNuevoItem('categoria')"
                class="bg-cyan-600 hover:bg-cyan-700 flex items-center justify-center w-10 h-10 rounded-md text-xl font-bold"
              >
                +
              </button>
            </div>
          </div>

          <!-- Cuenta -->
          <div class="sm:col-span-2">
            <label for="select-cuenta" class="block mb-1 text-slate-400 font-medium"
              >Cuenta</label
            >
            <div class="flex items-center gap-2">
              <select id="select-cuenta" class="flex-grow" placeholder="Busca o selecciona..."></select>
              <button
                type="button"
                onclick="crearNuevoItem('cuenta')"
                class="bg-cyan-600 hover:bg-cyan-700 flex items-center justify-center w-10 h-10 rounded-md text-xl font-bold"
              >
                +
              </button>
            </div>
          </div>

          <!-- Egresos / Ingresos -->
          <div>
            <label for="input-egresos" class="block mb-1 text-slate-400 font-medium"
              >Egresos ($)</label
            >
            <input
              type="number"
              step="0.01"
              id="input-egresos"
              class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
            />
          </div>
          <div>
            <label for="input-ingresos" class="block mb-1 text-slate-400 font-medium"
              >Ingresos ($)</label
            >
            <input
              type="number"
              step="0.01"
              id="input-ingresos"
              class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
            />
          </div>
        </div>

        <!-- Confirm / cancel -->
        <div id="confirmationControls" class="flex justify-center gap-4 pt-4">
          <button
            type="button"
            id="acceptButton"
            class="bg-green-600 hover:bg-green-700 py-2 px-6 rounded-lg font-semibold"
          >
            Guardar
          </button>
          <button
            type="button"
            id="cancelButton"
            class="bg-red-600 hover:bg-red-700 py-2 px-6 rounded-lg font-semibold"
          >
            Cancelar
          </button>
        </div>
      </form>
    </section>

    <!-- Status & transcription -->
    <div id="statusBox" class="min-h-[1.75rem] text-center text-sm font-medium text-slate-400"></div>
    <div
      id="transcriptionBox"
      class="bg-slate-800/40 rounded-lg p-3 text-xs text-slate-400 italic"
    ></div>
  </main>

  <!-- ========================  SCRIPT  ======================== -->
  <script>
    // --------- variables de referencia UI ---------
    const talkButton = document.getElementById('talkButton');
    const formContainer = document.getElementById('formContainer');
    const instructionText = document.getElementById('instructionText');
    const statusBox = document.getElementById('statusBox');
    const transcriptionBox = document.getElementById('transcriptionBox');
    const acceptButton = document.getElementById('acceptButton');
    const cancelButton = document.getElementById('cancelButton');

    let tomSelectCategoria, tomSelectCuenta;
    let isRecording = false;

    // --------- Speech API ---------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      statusBox.textContent = 'Tu navegador no soporta la API de voz.';
      talkButton.disabled = true;
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-ES';
      recognition.continuous = false; // móvil friendly
      recognition.interimResults = false;

      recognition.onstart = () => {
        isRecording = true;
        talkButton.classList.add('pulse', 'bg-red-600');
        talkButton.classList.remove('bg-cyan-600');
        instructionText.textContent = 'Escuchando...';
        statusBox.textContent = '';
        transcriptionBox.innerHTML = '';
      };

      recognition.onend = () => {
        isRecording = false;
        talkButton.classList.remove('pulse', 'bg-red-600');
        talkButton.classList.add('bg-cyan-600');
        instructionText.textContent = 'Presiona el micrófono para hablar.';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        if (transcript.trim()) {
          transcriptionBox.innerHTML = `<p><i>"${transcript}"</i></p>`;
          analizarTexto(transcript);
        }
      };

      recognition.onerror = (event) => {
        console.error('SpeechRecognition error:', event.error);
        statusBox.textContent = `Error de micrófono: ${event.error}. Asegúrate de dar permisos y usar HTTPS.`;
        isRecording = false;
      };

      talkButton.addEventListener('click', () => {
        if (isRecording) {
          recognition.stop();
        } else {
          resetState();
          try {
            recognition.start();
          } catch (e) {
            console.error('Error al iniciar reconocimiento:', e);
            statusBox.textContent = 'No se pudo iniciar el micrófono.';
          }
        }
      });
    }

    // --------- IA + Google Sheets backend ---------
    async function analizarTexto(texto) {
      statusBox.textContent = 'Analizando con IA...';
      talkButton.disabled = true;

      try {
        const response = await fetch('/analizar/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ texto })
        });
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        populateAndShowForm(result);
      } catch (err) {
        statusBox.textContent = `❌ Error: ${err.message}`;
        resetState();
      }
    }

    function populateAndShowForm(data) {
      const { datos_extraidos, todas_las_categorias, todas_las_cuentas } = data;
      statusBox.textContent = '';

      if (tomSelectCategoria) tomSelectCategoria.destroy();
      if (tomSelectCuenta) tomSelectCuenta.destroy();

      document.getElementById('input-fecha').value = datos_extraidos.fecha || '';
      document.getElementById('input-descripcion').value = datos_extraidos.descripcion || '';
      document.getElementById('input-egresos').value = datos_extraidos.egresos || 0;
      document.getElementById('input-ingresos').value = datos_extraidos.ingresos || 0;

      tomSelectCategoria = new TomSelect('#select-categoria', {
        options: todas_las_categorias.map(c => ({ value: c, text: c })),
        create: false,
        searchField: 'text'
      });
      tomSelectCategoria.addItem(datos_extraidos.categoria, true);

      tomSelectCuenta = new TomSelect('#select-cuenta', {
        options: todas_las_cuentas.map(c => ({ value: c, text: c })),
        create: false,
        searchField: 'text'
      });
      tomSelectCuenta.addItem(datos_extraidos.cuenta, true);

      instructionText.textContent = 'Verifica y corrige la información.';
      talkButton.classList.add('hidden');
      formContainer.classList.remove('hidden');
    }

    async function crearNuevoItem(tipo) {
      const nombre = window.prompt(`Introduce el nombre para la nueva ${tipo}:`);
      if (!nombre || !nombre.trim()) return;

      statusBox.textContent = `Creando nueva ${tipo}...`;
      try {
        const response = await fetch(`/crear/${tipo}/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre })
        });
        const result = await response.json();
        if (result.error || result.status !== 'success') throw new Error(result.message || 'Error desconocido');

        statusBox.textContent = `¡'${result.nuevo_valor}' creado!`;
        const selector = tipo === 'categoria' ? tomSelectCategoria : tomSelectCuenta;
        selector.clearOptions();
        result.nuevas_opciones.forEach(o => selector.addOption({ value: o, text: o }));
        selector.addItem(result.nuevo_valor);
      } catch (err) {
        statusBox.textContent = `❌ Error al crear: ${err.message}`;
      }
    }

    async function registrarDatos() {
      statusBox.textContent = 'Guardando en Google Sheets...';
      const datos = {
        fecha: document.getElementById('input-fecha').value,
        descripcion: document.getElementById('input-descripcion').value,
        egresos: parseFloat(document.getElementById('input-egresos').value) || 0,
        ingresos: parseFloat(document.getElementById('input-ingresos').value) || 0,
        categoria: tomSelectCategoria.getValue(),
        cuenta: tomSelectCuenta.getValue()
      };

      try {
        const response = await fetch('/registrar/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ datos })
        });
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        statusBox.textContent = `✅ ¡Éxito! ${result.message}`;
        setTimeout(resetState, 2000);
      } catch (err) {
        statusBox.textContent = `❌ Error al guardar: ${err.message}`;
      }
    }

    function resetState() {
      if (tomSelectCategoria) tomSelectCategoria.destroy();
      if (tomSelectCuenta) tomSelectCuenta.destroy();
      formContainer.classList.add('hidden');
      talkButton.classList.remove('hidden');
      talkButton.disabled = false;
      isRecording = false;
      instructionText.textContent = 'Presiona el micrófono para hablar.';
      statusBox.textContent = '';
      transcriptionBox.innerHTML = '';
    }

    acceptButton.addEventListener('click', registrarDatos);
    cancelButton.addEventListener('click', resetState);
  </script>
</body>
</html>
